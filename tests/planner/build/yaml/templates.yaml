import:
  - /tests/planner/build/python/planning.py

templates:
  action:
    args:
      required: [script]
      optional:
        preconditions: []
        immediate: None
        postconditions: None
        post_check_condition: None
    view_exclude: [children, preconditions, immediate, postconditions, post_check_conditions]
    make: make_action(preconditions, script, immediate, postconditions)
    # note! either immediate or postconditions should be set :)

  var_condition:
    args:
      required: [var]
      view_exclude: [children]

    nodes:
      $name:
        type: skipper
        children: [~SV, ~FV]

      ~SV:
        type: condition
        true_state: SUCCESS
        false_state: RUNNING
        expression: $var == SUCCESS
        var: $var
        val: SUCCESS

      ~FV:
        type: condition
        true_state: FAILURE
        false_state: RUNNING
        expression: $var == FAILURE
        var: $var
        val: SUCCESS
    children: [~SV, ~FV]


  precondition:
    args:
      required: [var]
      optional:
        false_state: FAILURE
        val: SUCCESS
        cond_type: condition
      view_exclude: [children, cond_type]
    cache: true
    nodes:
      $name:
        type: sequence
        children: [~fallback, ~gc2]
        view:
          expression: $var == $val
          on_F: $false_state
      ~fallback:
        type: fallback
        children: [~skipper, ~fix_F]
      ~skipper:
        type: skipper
        children: [~gc1, ~fix_R]
      ~fix_R:
        type: sequence
        children: [~dumb1]
      ~fix_F:
        type: sequence
        children: [~dumb2]
      ~dumb1:
        type: condition
        expression: True
        true_state: SUCCESS
        false_state: SUCCESS
      ~dumb2:
        type: condition
        expression: True
        true_state: SUCCESS
        false_state: SUCCESS
      ~gc1:
        type: $cond_type
        expression: $var == $val
        var: $var
        val: $val
        true_state: SUCCESS
        false_state: $false_state
      ~gc2:
        type: $cond_type
        expression: $var == $val
        var: $var
        val: $val
        true_state: SUCCESS
        false_state: $false_state
    children: [~gc1, ~fix_R, ~fix_F]

## actions

  find_in:
    args:
      required: [object, places]
      construct:
        _children_places:
          from: places
          V: ~$V_resolve
      view_exclude: [children]
    nodes:
      $name:
        type: sequence
        children: $_children_places
        view:
          object: $object


    unpack:
      places:
        nodes:
          ~$V_resolve:
            type: fallback
            children: [~$V_if_seen, ~$V_go_and_detect]

          ~$V_go_and_detect:
            type: sequence
            children: [~$V_force_goto, ~$V_detect]

          ~$V_if_seen:
            type: t/seen
            what: $object
            cont_type: condition
            val: RUNNING

          ~$V_force_goto:
            type: t/close_to_place
            place: $V

          ~$V_detect:
            type: t/detect
            object: $object
            seen_prec: FAILURE

    children: []
  find:
    args:
      required: [object]

    nodes:
      $name:
        type: t/find_in
        object: $object
        places: [table1, table2]
        preconditions:
          - type: t/seen
            what: $object
            val: FAILURE
            cond_type: condition
        postconditions:
          - seen[$object]: SUCCESS
            prob: 0.9
          - seen[$object]: FAILURE
            prob: 0.1



  detect_on:
    args:
      required: [object, place]

    nodes:
      $name:
        type: t/action
        preconditions:
          - type: t/close_to_place
            place: $place
          - type: t/has
            place: $place
            object: $object
            val: RUNNING
            cond_type: condition
        postconditions:
          - has[$place][$object]: SUCCESS
            prob: 0.5
          - has[$place][$object]: FAILURE
            prob: 0.5
        script: detect($object);

  goto:
    args:
      required: [location]

    nodes:
      $name:
        type: t/action
        postconditions:
          - location: $location
            prob: 0.9
          - location: ANY
            prob: 0.1
        script: move_to($location);
    cache: true
    children: []

  move_closer:
    args:
      required: [object]

    nodes:
      $name:
        type: t/action
        preconditions:
          - type: t/close_to_object
            object: $object
            val: FAILURE
            cond_type: condition
          - type: t/seen
            what: $object
        postconditions:
          - close_to_object[$object]: SUCCESS
            prob: 0.9
          - prob: 0.1
        script: move_closer($object);
    cache: true
    children: []

  put:
    args:
      required: [object, place]

    nodes:
      $name:
        type: t/action
        preconditions:
          - type: t/grasped
            object: $object
          - type: t/close_to_place
            place: $place
        postconditions:
          - grasped: None
            has[$place][$object]: SUCCESS
            prob: 0.9
          - grasped: None
            has[ANY][$object]: SUCCESS
            close_to_object[$object]: RUNNING
            seen[$object]: FAILURE
            prob: 0.09
          - prob: 0.01
        script: put($object, $place);
    cache: true
    children: []

  grasp:
    args:
      required: [object]

    nodes:
      $name:
        type: t/action
        preconditions:
          - type: t/close_to_object
            object: $object
          - type: t/grasped
            object: None
        postconditions:
          - grasped: $object
            prob: 0.8
          - prob: 0.2
        script: grasp($object);
    cache: true
    children: []

  detect:
    args:
      required: [object]
      optional:
        seen_prec: RUNNING

    nodes:
      $name:
        type: t/action
        preconditions:
          - type: t/luminousity
          - type: t/seen
            what: $object
            val: $seen_prec
            cond_type: condition
        postconditions:
          - seen[$object]: SUCCESS
            prob: 0.5
          - seen[$object]: FAILURE
            prob: 0.5
        script: seen[$object] = detect($object);
    cache: true
    children: []

  light_on:
    args:
      required: [location]

    nodes:
      $name:
        type: t/action
        postconditions:
          - luminousity[$location]: SUCCESS
            prob: 1
        script: light_on($location)
    cache: true
    children: []

  measure_distance:
    args:
      required: [object]

    nodes:
      $name:
        type: t/action
        preconditions:
          - type: t/seen
            what: $object
          - type: t/close_to_object
            object: $object
            val: RUNNING
            cond_type: condition

        postconditions:
          - close_to_object[$object]: SUCCESS
            prob: 0.5
          - close_to_object[$object]: FAILURE
            prob: 0.5
        script: close_to_object[$object] = measure_reachability($object);
    cache: true
    children: []


## conditions

  grasped:
    args:
      required: [object]
      view_exclude: [children]
    nodes:
      $name:
        type: t/precondition
        var: grasped
        val: $object
    cache: true

  at:
    args:
      required: [location]
      view_exclude: [children]
    nodes:
      $name:
        type: t/precondition
        var: location
        val: $location
    cache: true

  close_to_object:
    args:
      required: [object]
      optional:
        val: SUCCESS
        cond_type: t/var_condition
      view_exclude: [children]
    nodes:
      $name:
        type: t/precondition
        var: close_to_object[$object]
        val: $val
        cond_type: $cond_type
    cache: true

  seen:
    args:
      required: [what]
      optional:
        false_state: FAILURE
        val: SUCCESS
        cond_type: t/var_condition
      view_exclude: [children]
    nodes:
      $name:
        type: t/precondition
        var: seen[$what]
        val: $val
        false_state: $false_state
        cond_type: $cond_type
    cache: true

  luminousity:
    args:
      optional:
        location: location
        false_state: FAILURE
      view_exclude: [children]
    nodes:
      $name:
        type: t/precondition
        var: luminousity[$location]
        false_state: $false_state
    cache: true

  has:
    args:
      required: [object, place]
      optional:
        val: SUCCESS
        cond_type: t/var_condition
      view_exclude: [children]
    nodes:
      $name:
        type: t/precondition
        var: has[$place][$object]
        val: $val
        cond_type: $cond_type
    cache: true

  close_to_place:
    args:
      required: [place]
      view_exclude: [children]
    nodes:
      $name:
        type: t/precondition
        var: closeness[location][$place]
    cache: true



